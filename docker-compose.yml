# Vision UI MCP Server â€” Docker Compose
#
# Start:  docker compose up -d
# Stop:   docker compose down
# Logs:   docker compose logs -f

services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: vision_ui_index
      POSTGRES_USER: vision_ui
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-vision_ui_dev}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vision_ui -d vision_ui_index"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  indexer:
    image: ghcr.io/montycloud/mc-vision-ui-mcp-server/vision-ui-indexer:latest
    environment:
      VISION_UI_REPO: ${VISION_UI_REPO}
      APP_REPO: ${APP_REPO:-}
      APP_FE_PATH: ${APP_FE_PATH:-app/app}
      GIT_TOKEN: ${GIT_TOKEN:-}
      DOCS_DIR: /app/docs
      OUTPUT_DIR: /app/extracted
      COMPONENTS_DIR: ${COMPONENTS_DIR:-src/components}
    volumes:
      - extracted_data:/app/extracted
      - repos_data:/app/repos
      - ./docs:/app/docs:ro
    depends_on:
      postgres:
        condition: service_healthy

  mcp-server:
    image: ghcr.io/montycloud/mc-vision-ui-mcp-server/vision-ui-mcp-server:latest
    environment:
      DATABASE_URL: postgresql://vision_ui:${POSTGRES_PASSWORD:-vision_ui_dev}@postgres:5432/vision_ui_index
      COCOINDEX_DATABASE_URL: postgresql://vision_ui:${POSTGRES_PASSWORD:-vision_ui_dev}@postgres:5432/vision_ui_index
      EXTRACTED_DIR: /app/extracted
      CONVENTIONS_PATH: /app/docs/conventions.md
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      EMBEDDING_BATCH_SIZE: ${EMBEDDING_BATCH_SIZE:-20}
      VISION_UI_TRANSPORT: http
      VISION_UI_HTTP_HOST: 0.0.0.0
      VISION_UI_HTTP_PORT: 8080
    ports:
      - "${MCP_PORT:-8080}:8080"
    volumes:
      - extracted_data:/app/extracted
      - repos_data:/app/repos:ro
      - ./docs:/app/docs:ro
    depends_on:
      indexer:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  reindex-watcher:
    image: ghcr.io/montycloud/mc-vision-ui-mcp-server/vision-ui-indexer:latest
    entrypoint: ["./entrypoint-watcher.sh"]
    environment:
      VISION_UI_REPO: ${VISION_UI_REPO}
      APP_REPO: ${APP_REPO:-}
      APP_FE_PATH: ${APP_FE_PATH:-app/app}
      GIT_TOKEN: ${GIT_TOKEN:-}
      DOCS_DIR: /app/docs
      OUTPUT_DIR: /app/extracted
      COMPONENTS_DIR: ${COMPONENTS_DIR:-src/components}
      POLL_INTERVAL: ${POLL_INTERVAL:-120}
      COOLDOWN: ${COOLDOWN:-60}
      DEFAULT_BRANCH: ${DEFAULT_BRANCH:-main}
    volumes:
      - extracted_data:/app/extracted
      - repos_data:/app/repos
      - ./docs:/app/docs:ro
    depends_on:
      indexer:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f entrypoint-watcher || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  pgdata:
  extracted_data:
  repos_data:
